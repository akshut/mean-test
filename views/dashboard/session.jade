mixin session(session)
  li.session(id=session._id)
    p.name Patient
    img.avatar(src="//lorempixel.com/125/125", alt="patient", width="100", height="70px")
    span.chat-notification
      i.fa.fa-comment
    .chat
  video(id= 'video-' + session._id, width="4px", height="4px", style="position:absolute;left:-9999999px")

    script.
      (function(session) {

        function sessionConnectedHandler(event) {
          // session.publish(publisher)
          subscribeToStreams(event.streams)
        }

        function subscribeToStreams(streams) {
          for (var i = 0; i < streams.length; i++) {
            var stream = streams[i];
            if (stream.connection.connectionId
                   != tokSession.connection.connectionId) {

                var subscriber = tokSession.subscribe(
                                    stream
                                  , 'video-' + session._id,
                                    {
                                      subscribeToVideo: false
                                    , subscribeToAudio: false
                                    }
                                 );
            }
          }
        }

        function streamCreatedHandler(event) {
          subscribeToStreams(event.streams);
        }

        // var publisher = TB.initPublisher(session.API_KEY, 'myPublisherDiv', {height: "135px", width: "180px"});
        var tokSession   = TB.initSession(session.sessionId);


        tokSession.connect(session.API_KEY, session.token);

        tokSession.on("sessionConnected",
                                 sessionConnectedHandler);

        tokSession.on("streamCreated",
                                 streamCreatedHandler);

        var avatar = [];

        tokSession.on('signal:image-begin', function() {
          avatar = [];
          console.log("image commin");
        })

        tokSession.on('signal:image-chunk', function(e) {
          avatar.push(e.data.img)
        })

        tokSession.on('signal:image-end', function() {
          $('li.session#' + session._id + ' img')
          .attr('src', 'data:image/png;base64,' + avatar.join(''))
        })

        tokSession.on('signal:name', function(e) {
          $('li.session#' + session._id + ' p')
          .text(e.data.name)
        })

        var $chatNotification = $('li.session#' + session._id + ' span.chat-notification')
          , $chat = $('li.session#' + session._id + ' .chat')

        
        var chatTemplate = templatizer.public.chat.chat('doctor', tokSession)

        console.log(chatTemplate)
        $chat.html(chatTemplate)

        tokSession.on('signal:chat-patient', function(e) {
          $chatNotification.find('i').css('color', 'red')
        })

        $chat.click(function() {
          $chatNotification.find('i').css('color', 'black')
        })

        function openChat() {
          $chatNotification.find('i').removeClass('fa-comment').addClass('fa-comment-o')
          $chat.addClass('open')
        }

        function closeChat() {
          $chatNotification.find('i').addClass('fa-comment').removeClass('fa-comment-o')
          $chat.removeClass('open')
        }

        $chatNotification.click(function() {
          console.log("YOLO")
          $chatNotification.find('i').css('color', 'black')
          openChat()
        })

        $(document).mouseup(function (e) {
          if (!$chat.is(e.target) // if the target of the click isn't the container...
            && $chat.has(e.target).length === 0){ // ... nor a descendant of the container
              closeChat()
          }
        });

        // Handle initiating of conference call
        $('li.session#' + session._id + ' img.avatar').click(function() {
          activateSession(tokSession)
        })

      })(!{JSON.stringify(session)})
